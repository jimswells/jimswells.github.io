<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0b0f" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Destiny Team Bingo</title>
  <link rel="manifest" href="./manifest.webmanifest" id="mfLink">
  <link rel="apple-touch-icon" href="logo.png" />
  <link rel="icon" href="logo.png" />
  <style>
    :root{ --bg:#0b0b0f; --card:#ffffff; --ink:#000; --gold:#f9ae43; --accent:#7a2f2f; --hero:#1e3a8a; --btn:#0f172a; --muted:#9ca3af }
    html,body{height:100%} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Noto Sans;background:#0d192f;color:#fff;display:flex;flex-direction:column;align-items:center}
    header{margin-top: 5px;width:100%;max-width:860px;padding:90px 16px 8px;box-sizing:border-box;text-align:center}
    .logoWrap{display:flex;align-items:center;justify-content:center;gap:10px}
    .dclCrest{width:42px;height:42px;margin-top: -25px;}
    .titleBlock{display:flex;flex-direction:column;align-items:center}
    .titleText{font-weight:900;letter-spacing:.6px;font-size:clamp(22px,6vw,36px);line-height:1.05;text-transform:uppercase}
    .badge{margin-left: -60px;display:inline-block;margin-top:4px;padding:2px 10px;border-radius:999px;border:1px solid var(--gold);color:var(--gold);font-weight:700;font-size:.85em;letter-spacing:.08em}
    .who{margin-top:4px;font-size:.9rem;color:var(--muted)} .subtitle{margin-top:6px;font-size:.95rem;color:#cbd5e1} .completed{margin-top:8px;font-size:1rem;font-weight:700;color:#a7f3d0;min-height:1.2em}
    main{width:100%;max-width:860px;padding:8px 16px 24px;box-sizing:border-box}
    .board{margin:12px auto 8px;width:100%;aspect-ratio:1/1;max-width:720px;display:grid;grid-template-columns:repeat(5,1fr);grid-template-rows:repeat(5,1fr);gap:6px}
    .cell{user-select:none;-webkit-tap-highlight-color:transparent;background:var(--card);color:var(--ink);border-radius:10px;border:2px solid #111;box-shadow:0 1px 2px rgba(0,0,0,.35) inset;display:flex;align-items:center;justify-content:center;text-align:center;padding:6px;font-weight:600;line-height:1.1;font-size:clamp(12px,3.1vw,18px);transition:transform .04s ease,background .15s ease,color .15s ease,box-shadow .15s ease}
    .cell:active{transform:scale(.98)} .cell.selected{background:#000;color:#fff;border-color:#fff;font-weight:800;box-shadow:0 0 0 2px #fff inset,0 2px 10px rgba(0,0,0,.5)}
    .cell.free{background:linear-gradient(135deg,var(--hero),var(--accent));color:#fff;border-color:var(--gold);font-weight:900;letter-spacing:.04em;box-shadow:0 0 0 2px var(--gold) inset,0 6px 18px rgba(0,0,0,.35)}
    .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:50px 14px 0 4px}
    .btn{border:1px solid #374151;background:var(--btn);color:#e5e7eb;padding:10px 14px;border-radius:10px;font-weight:800;letter-spacing:.2px}
    .btn:active{transform:translateY(1px)} .shareWrap{margin-top:8px;text-align:center;color:var(--muted);font-size:.9rem}
    .shareLink{word-break:break-all;font-family:ui-monospace,Menlo,Consolas,monospace;color:#e5e7eb}
    #confetti{position:fixed;inset:0;width:100vw;height:100vh;pointer-events:none;z-index:9999;display:none}
    @media (max-width:420px){.board{gap:5px}.cell{padding:4px;border-radius:8px}}
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>

  <header>
    <div class="logoWrap">
      <img class="dclCrest" src="logo.png" />
      <div class="titleBlock">
        <div class="titleText">Destiny Team Bingo</div>
        <div class="badge">DCL Â· Heroes vs Villains</div>
      </div>
    </div>
    <div class="who" id="who"></div>
    <div class="completed" id="completed"></div>
  </header>

  <main>
    <section class="board" id="board" aria-label="Bingo Board" role="grid"></section>
    <div class="controls">
      <button class="btn" id="resetBtn">Reset board</button>
      <button class="btn" id="copyBtn">Share Bingo Sheet</button>
    </div>
    <div class="shareWrap"><span id="shareOut"></span></div>
  </main>

  <script id="manifest" type="application/manifest+json">{
    "name":"Destiny Team Bingo",
    "short_name":"Destiny Bingo",
    "start_url":"./",
    "display":"standalone",
    "background_color":"#0b0b0f",
    "theme_color":"#0b0b0f",
    "icons":[
      {"src":"icon-192.png","sizes":"192x192","type":"image/png"},
      {"src":"icon-512.png","sizes":"512x512","type":"image/png"}
    ]
  }</script>

  <script>
  (function(){
    // ========= Minimal icon generation (keeps it 3-file deploy with auto icons) =========
    function makeIcon(size){
      const c=document.createElement('canvas'); c.width=c.height=size; const g=c.getContext('2d');
      const grd=g.createLinearGradient(0,0,size,size); grd.addColorStop(0,'#1e3a8a'); grd.addColorStop(1,'#7a2f2f'); g.fillStyle=grd; g.fillRect(0,0,size,size);
      g.strokeStyle='#caa034'; g.lineWidth=size*0.06; g.beginPath(); g.arc(size/2,size/2,size*0.42,0,Math.PI*2); g.stroke();
      g.fillStyle='#caa034'; const s=size*0.09; g.beginPath(); for(let i=0;i<5;i++){ const a=-Math.PI/2+i*2*Math.PI/5; const x=size/2+Math.cos(a)*s*2; const y=size/2-size*0.22+Math.sin(a)*s*2; g.lineTo(x,y); const a2=a+Math.PI/5; g.lineTo(size/2+Math.cos(a2)*s, size/2-size*0.22+Math.sin(a2)*s);} g.closePath(); g.fill();
      return c.toDataURL('image/png');
    }
    // write data URLs as linkable icons
    const icon192 = makeIcon(192), icon512 = makeIcon(512);
    //const a1=document.createElement('link'); a1.rel='icon'; a1.sizes='192x192'; a1.href=icon192; document.head.appendChild(a1);
    const a2=document.createElement('link'); a2.rel='apple-touch-icon'; a2.href=icon192; document.head.appendChild(a2);

    // build manifest blob from inline JSON, swapping icon URLs to data URLs
    const mf = JSON.parse(document.getElementById('manifest').textContent);
    mf.icons[0].src = icon192; mf.icons[1].src = icon512;
    const mfBlob = new Blob([JSON.stringify(mf)], {type:'application/manifest+json'});
    const mfUrl = URL.createObjectURL(mfBlob);
    document.getElementById('mfLink').href = mfUrl;

    // ========= App logic (same as V2: cookies + sharing + confetti) =========
    function setCookie(n,v,d){ const e=new Date(Date.now()+d*864e5).toUTCString(); document.cookie=`${n}=${encodeURIComponent(v)};expires=${e};path=/;SameSite=Lax`; }
    function getCookie(n){ const m=document.cookie.match(new RegExp('(?:^|; )'+n.replace(/([.$?*|{}()\[\]\\\/\+^])/g,'\\$1')+'=([^;]*)')); return m?decodeURIComponent(m[1]):null; }
    function delCookie(n){ document.cookie=n+'=; Max-Age=-1; path=/;'; }

    const P='dcl_destiny_bingo_'; const C_NAME=P+'name', C_ORDER=P+'order', C_CLICKS=P+'clicks', C_SOLVED=P+'solvedAt', C_LISTHASH=P+'listHash';
    const boardEl=document.getElementById('board'), whoEl=document.getElementById('who'), completedEl=document.getElementById('completed'), shareOut=document.getElementById('shareOut');

    let playerName=getCookie(C_NAME); if(!playerName){ playerName=(prompt('Who are you?')||'').trim(); if(playerName) setCookie(C_NAME,playerName,3650);} whoEl.textContent=playerName?`Player: ${playerName}`:'';

    function getParam(k){ return new URL(location.href).searchParams.get(k); }
    function b64D(s){ if(!s) return ''; s=s.replace(/-/g,'+').replace(/_/g,'/'); while(s.length%4) s+='='; try{return decodeURIComponent(escape(atob(s)));}catch(e){ try{return atob(s);}catch(e2){return '';} } }
    function b64E(s){ try{return btoa(unescape(encodeURIComponent(s)));}catch(e){return btoa(s);} }
    function hash(s){ let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0;} return ''+h; }

    const size=5, total=25, center=12; const dataParam=getParam('data'), orderParam=getParam('order');
    const raw=b64D(dataParam||''); const list=raw?raw.split(';').map(s=>s.trim()).filter(Boolean):[]; const listHash=list.length?hash(list.join(';')):'';

    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]];} return a; }

    function buildOrder(){ if(orderParam){ try{ const arr=JSON.parse(b64D(orderParam)); if(Array.isArray(arr)&&arr.length===total){ setCookie(C_ORDER,JSON.stringify(arr),3650); setCookie(C_LISTHASH,'orderParam',3650); return arr; } }catch{} }
      const sh=getCookie(C_LISTHASH), so=getCookie(C_ORDER); if(so && (sh===listHash||sh==='orderParam')){ try{ const o=JSON.parse(so); if(Array.isArray(o)&&o.length===total) return o; }catch{} }
      let pool=list.slice(); while(pool.length<24) pool.push(''); pool=shuffle(pool).slice(0,24);
      const ord=new Array(total).fill(null); let k=0; for(let i=0;i<total;i++){ ord[i]= i===center? 'FREE SPACE' : (pool[k++]||''); }
      setCookie(C_ORDER,JSON.stringify(ord),3650); setCookie(C_LISTHASH,listHash||'generated',3650); return ord; }

    let order=buildOrder();
    function getClicks(){ const r=getCookie(C_CLICKS); if(r){ try{ const a=JSON.parse(r); if(Array.isArray(a)&&a.length===total) return a; }catch{} } const a=new Array(total).fill(false); a[center]=true; return a; }
    let clicks=getClicks(); function saveClicks(){ setCookie(C_CLICKS,JSON.stringify(clicks),3650); }

    function render(){ boardEl.innerHTML=''; for(let i=0;i<total;i++){ const el=document.createElement('button'); el.className='cell'+(i===center?' free':'')+(clicks[i]?' selected':''); el.setAttribute('role','gridcell'); el.setAttribute('aria-pressed',clicks[i]?'true':'false'); el.innerHTML=(order[i]||'\u200b'); if(i!==center){ el.addEventListener('click',()=>{ clicks[i]=!clicks[i]; saveClicks(); el.classList.toggle('selected'); el.setAttribute('aria-pressed',clicks[i]?'true':'false'); checkBingo(); }); } boardEl.appendChild(el);} clicks[center]=true; saveClicks(); checkBingo(true); }

    // confetti
    const cnv=document.getElementById('confetti'), cx=cnv.getContext('2d'); function rs(){ cnv.width=innerWidth; cnv.height=innerHeight; } addEventListener('resize',rs); rs(); let active=false,p=[],t0=0; function celebrate(){ active=true; cnv.style.display='block'; p=[]; const cs=['#fff','#caa034','#1e3a8a','#7a2f2f']; for(let i=0;i<1000;i++) p.push({x:Math.random()*cnv.width,y:-10-Math.random()*cnv.height*0.5,w:6+Math.random()*6,h:2+Math.random()*4,s:1+Math.random()*2.5,a:Math.random()*6.28,c:cs[(Math.random()*cs.length)|0]}); t0=performance.now(); requestAnimationFrame(step); }
    function step(ts){ if(!active) return; const dt=ts-t0; cx.clearRect(0,0,cnv.width,cnv.height); for(const q of p){ q.y+=q.s*2; q.x+=Math.sin((q.y+q.a)/20)*0.9; cx.save(); cx.translate(q.x,q.y); cx.rotate((q.y+q.a)/25); cx.fillStyle=q.c; cx.fillRect(-q.w/2,-q.h/2,q.w,q.h); cx.restore(); } if(dt<4200) requestAnimationFrame(step); else { active=false; cnv.style.display='none'; } }

    function checkBingo(initial){ const lines=[]; for(let r=0;r<size;r++) lines.push([0,1,2,3,4].map(c=>r*size+c)); for(let c=0;c<size;c++) lines.push([0,1,2,3,4].map(r=>r*size+c)); lines.push([0,6,12,18,24],[4,8,12,16,20]); let solved=false; for(const L of lines){ if(L.every(i=>clicks[i])){ solved=true; break; } } let solvedAt=getCookie(C_SOLVED); if(solved && !solvedAt){ solvedAt=new Date().toISOString(); setCookie(C_SOLVED,solvedAt,3650); celebrate(); if('vibrate' in navigator){ try{ navigator.vibrate([40,30,40]); }catch{} } } if(solvedAt){ try{ completedEl.textContent=`Completed: ${new Date(solvedAt).toLocaleString()}`; }catch{ completedEl.textContent=`Completed: ${solvedAt}`; } } else if(!initial){ completedEl.textContent=''; } }

    function shareUrl(){ const b64=b64E(JSON.stringify(order)); const u=new URL(location.href); u.searchParams.set('order',b64); return u.toString(); }
    document.getElementById('copyBtn').onclick=async()=>{ const l=shareUrl(); try{ await navigator.clipboard.writeText(l); alert('Link copied to clipboard!'); shareOut.textContent='Link copied to clipboard!'; }catch{ document.getElementById('shareBtn').click(); } };
    document.getElementById('resetBtn').onclick=()=>{ clicks=new Array(total).fill(false); clicks[center]=true; saveClicks(); delCookie(C_SOLVED); completedEl.textContent=''; render(); };

    if(!list.length && !getCookie(C_ORDER) && !orderParam){ alert('Add your semicolon-separated list (base64) via ?data=... in the URL.'); }
    render();

    // ========= TRUE PWA: register a real sw.js (Blob/data URLs are not allowed) =========
    if('serviceWorker' in navigator){
      // scope './' works whether you host as /index.html or /bingo.html
      navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(()=>{});
    }
  })();
  </script>
</body>
</html>
