<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Destiny Team Bingo</title>
  <style>
    :root{
      --bg:#0b0b0f; /* subtle space vibe */
      --card:#ffffff;
      --ink:#000000;
      --gold:#caa034;
      --accent:#7a2f2f; /* villain hint */
      --hero:#1e3a8a; /* hero hint */
      --btn:#0f172a;
      --muted:#9ca3af;
    }
    html,body{height:100%;}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: #fff;
      display:flex; flex-direction:column; align-items:center;
    }

    /* ---------- Header & Logo ---------- */
    header{ width:100%; max-width:860px; padding:16px 16px 8px; box-sizing:border-box; text-align:center; }
    .logoWrap{ display:flex; align-items:center; justify-content:center; gap:10px; }
    .dclCrest{ width:42px; height:42px; }
    .titleBlock{ display:flex; flex-direction:column; align-items:center; }
    .titleText{ font-weight:900; letter-spacing:.6px; font-size: clamp(22px, 6vw, 36px); line-height:1.05; text-transform:uppercase; }
    .badge{ display:inline-block; margin-top:4px; padding:2px 10px; border-radius:999px; border:1px solid var(--gold); color:var(--gold); font-weight:700; font-size:.85em; letter-spacing:.08em; }
    .who{ margin-top:4px; font-size:.9rem; color:var(--muted); }
    .subtitle{ margin-top:6px; font-size:.95rem; color:#cbd5e1; }
    .completed{ margin-top:8px; font-size:1rem; font-weight:700; color:#a7f3d0; min-height:1.2em; }

    main{ width:100%; max-width:860px; padding:8px 16px 24px; box-sizing:border-box; }

    /* ---------- Board ---------- */
    .board{ margin:12px auto 8px; width:100%; aspect-ratio:1/1; max-width:720px; display:grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(5, 1fr); gap:6px; }
    .cell{ user-select:none; -webkit-tap-highlight-color: transparent; background: var(--card); color: var(--ink); border-radius:10px; border:2px solid #111; box-shadow: 0 1px 2px rgba(0,0,0,.35) inset; display:flex; align-items:center; justify-content:center; text-align:center; padding:6px; font-weight:600; line-height:1.1; font-size: clamp(12px, 3.1vw, 18px); transition: transform .04s ease, background .15s ease, color .15s ease, box-shadow .15s ease; }
    .cell:active{ transform: scale(.98); }
    .cell.selected{ background:#000; color:#fff; border-color:#fff; font-weight:800; box-shadow: 0 0 0 2px #fff inset, 0 2px 10px rgba(0,0,0,.5); }
    .cell.free{ background: linear-gradient(135deg, var(--hero), var(--accent)); color:#fff; border-color:var(--gold); font-weight:900; letter-spacing:.04em; box-shadow: 0 0 0 2px var(--gold) inset, 0 6px 18px rgba(0,0,0,.35); }

    /* ---------- Controls ---------- */
    .controls{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:14px 0 4px; }
    .btn{ border:1px solid #374151; background:var(--btn); color:#e5e7eb; padding:10px 14px; border-radius:10px; font-weight:800; letter-spacing:.2px; }
    .btn:active{ transform: translateY(1px); }
    .shareWrap{ margin-top:8px; text-align:center; color:var(--muted); font-size:.9rem; }
    .shareLink{ word-break:break-all; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; color:#e5e7eb; }

    .footer{ text-align:center; font-size:12px; color:var(--muted); margin:10px 0 16px; }

    /* ---------- Confetti Canvas ---------- */
    #confetti {
      position: fixed; inset: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 9999; display:none;
    }

    /* Small phones */
    @media (max-width:420px){ .board{ gap:5px; } .cell{ padding:4px; border-radius:8px; } }
  </style>
</head>
<body>
  <!-- Confetti canvas (no external libs, works offline) -->
  <canvas id="confetti"></canvas>

  <header>
    <div class="logoWrap">
      <!-- Simple inline crest: twin waves + star for a hero/villain vibe -->
      <svg class="dclCrest" viewBox="0 0 64 64" aria-hidden="true">
        <defs>
          <linearGradient id="hv" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#1e3a8a"/>
            <stop offset="100%" stop-color="#7a2f2f"/>
          </linearGradient>
        </defs>
        <circle cx="32" cy="32" r="30" fill="none" stroke="url(#hv)" stroke-width="3"/>
        <path d="M10 28c8-6 16-6 24 0s16 6 20 2" fill="none" stroke="#caa034" stroke-width="2"/>
        <path d="M10 36c8-6 16-6 24 0s16 6 20 2" fill="none" stroke="#caa034" stroke-width="2"/>
        <path d="M46 14l2.2 4.5 5 .7-3.6 3.5.9 5-4.5-2.4-4.5 2.4.9-5-3.6-3.5 5-.7z" fill="#caa034"/>
      </svg>
      <div class="titleBlock">
        <div class="titleText">Destiny Team Bingo</div>
        <div class="badge">DCL · Heroes vs Villains</div>
      </div>
    </div>
    <div class="who" id="who"></div>
    <div class="subtitle">Tap to mark squares. Full row, column, or diagonal = BINGO.</div>
    <div class="completed" id="completed"></div>
  </header>

  <main>
    <section class="board" id="board" aria-label="Bingo Board" role="grid"></section>
    <div class="controls">
      <button class="btn" id="resetBtn" title="Clear selections but keep your board order">Clear Marks</button>
      <button class="btn" id="reshuffleBtn" title="Make a brand‑new board using the URL list">Reshuffle</button>
      <button class="btn" id="shareBtn" title="Create a link that reproduces this exact board">Share This Board</button>
      <button class="btn" id="copyBtn" title="Copy the share link to clipboard">Copy Link</button>
    </div>
    <div class="shareWrap"><span id="shareOut"></span></div>
    <div class="footer">Offline friendly. Provide a base64 list in the URL like <code>?data=...</code> (semicolon‑separated). You can also use <code>order=...</code> to restore an exact layout.</div>
  </main>

  <script>
  (function(){
    // ---------- Cookie helpers ----------
    function setCookie(name, value, days){
      const d = new Date(); d.setTime(d.getTime() + (days*24*60*60*1000));
      document.cookie = `${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/;SameSite=Lax`;
    }
    function getCookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([.$?*|{}()\[\]\\\/\+^])/g, '\\$1') + '=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : null;
    }
    function delCookie(name){ document.cookie = name + '=; Max-Age=-1; path=/;'; }

    // ---------- Constants ----------
    const COOKIE_PREFIX = 'dcl_destiny_bingo_';
    const C_NAME = COOKIE_PREFIX + 'name';
    const C_ORDER = COOKIE_PREFIX + 'order';
    const C_CLICKS = COOKIE_PREFIX + 'clicks';
    const C_SOLVED = COOKIE_PREFIX + 'solvedAt';
    const C_LISTHASH = COOKIE_PREFIX + 'listHash';

    const Q_DATA = 'data';           // base64 ;‑separated list
    const Q_ORDER = 'order';         // base64 JSON array (25 items)

    const boardEl = document.getElementById('board');
    const whoEl = document.getElementById('who');
    const completedEl = document.getElementById('completed');
    const shareOut = document.getElementById('shareOut');

    // ---------- Player name ----------
    let playerName = getCookie(C_NAME);
    if(!playerName){
      playerName = (prompt('Who are you?') || '').trim();
      if(playerName){ setCookie(C_NAME, playerName, 3650); } // ~10 years
    }
    whoEl.textContent = playerName ? `Player: ${playerName}` : '';

    // ---------- URL helpers ----------
    function getParam(name){ const url = new URL(location.href); return url.searchParams.get(name); }
    function setParam(url, key, val){ url.searchParams.set(key, val); }
    function b64Decode(s){
      if(!s) return '';
      s = s.replace(/\-/g,'+').replace(/_/g,'/');
      while(s.length % 4) s += '=';
      try{ return decodeURIComponent(escape(atob(s))); }catch(e){ try{ return atob(s); }catch(e2){ return ''; } }
    }
    function b64Encode(str){
      try{ return btoa(unescape(encodeURIComponent(str))); } catch(e){ return btoa(str); }
    }
    function simpleHash(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return h.toString(); }

    // ---------- Data source from URL ----------
    const dataParam = getParam(Q_DATA);
    const orderParam = getParam(Q_ORDER);
    const decodedRaw = b64Decode(dataParam || '');
    const sourceList = decodedRaw ? decodedRaw.split(';').map(s=>s.trim()).filter(Boolean) : [];
    const listHash = sourceList.length ? simpleHash(sourceList.join(';')) : '';

    const size = 5; const totalCells = size*size; const centerIdx = 12; // 0-based index

    function shuffled(items){
      const a = items.slice();
      for(let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
      return a;
    }

    function buildOrder(){
      // 1) If URL carries an explicit order, prefer it and persist
      if(orderParam){
        try{
          const arr = JSON.parse(b64Decode(orderParam));
          if(Array.isArray(arr) && arr.length === totalCells){
            setCookie(C_ORDER, JSON.stringify(arr), 3650);
            setCookie(C_LISTHASH, 'orderParam', 3650);
            return arr;
          }
        }catch{}
      }
      // 2) Restore from cookie, but only if list hash matches (avoids cross-list reuse)
      const savedHash = getCookie(C_LISTHASH);
      const savedOrder = getCookie(C_ORDER);
      if(savedOrder && (savedHash === listHash || savedHash === 'orderParam')){
        try{ const o = JSON.parse(savedOrder); if(Array.isArray(o) && o.length===totalCells) return o; }catch{}
      }
      // 3) Generate a fresh order from the list
      let pool = sourceList.slice();
      if(pool.length < 24){ while(pool.length < 24) pool.push(''); }
      pool = shuffled(pool).slice(0,24);

      const order = new Array(totalCells).fill(null);
      let idx=0;
      for(let i=0;i<totalCells;i++){
        if(i === centerIdx){ order[i] = 'FREE SPACE'; continue; }
        order[i] = pool[idx++] || '';
      }
      setCookie(C_ORDER, JSON.stringify(order), 3650);
      setCookie(C_LISTHASH, listHash || 'generated', 3650);
      return order;
    }

    let order = buildOrder();

    // ---------- Click state ----------
    function getClicks(){
      const raw = getCookie(C_CLICKS);
      if(raw){ try{ const a = JSON.parse(raw); if(Array.isArray(a) && a.length===totalCells) return a; }catch{} }
      const a = new Array(totalCells).fill(false); a[centerIdx]=true; return a;
    }
    function saveClicks(){ setCookie(C_CLICKS, JSON.stringify(clicks), 3650); }

    let clicks = getClicks();

    // ---------- Render ----------
    function render(){
      boardEl.innerHTML='';
      for(let i=0;i<totalCells;i++){
        const div = document.createElement('button');
        div.className = 'cell' + (i===centerIdx ? ' free' : '') + (clicks[i] ? ' selected' : '');
        div.setAttribute('role','gridcell');
        div.setAttribute('aria-pressed', clicks[i] ? 'true' : 'false');
        div.dataset.index = String(i);
        div.innerHTML = (order[i] || '\u200b');
        if(i !== centerIdx){
          div.addEventListener('click', ()=>{
            clicks[i] = !clicks[i];
            saveClicks();
            div.classList.toggle('selected');
            div.setAttribute('aria-pressed', clicks[i] ? 'true' : 'false');
            checkBingo();
          });
        }
        boardEl.appendChild(div);
      }
      // ensure center is always selected
      clicks[centerIdx] = true; saveClicks();
      checkBingo(true);
    }

    // ---------- Bingo detection + Confetti ----------
    const confettiCanvas = document.getElementById('confetti');
    const cctx = confettiCanvas.getContext('2d');
    let confettiActive = false, confettiPieces = [], confettiStart = 0;

    function resizeCanvas(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function launchConfetti(){
      confettiActive = true;
      confettiCanvas.style.display = 'block';
      confettiPieces = [];
      const colors = ['#ffffff','#caa034','#1e3a8a','#7a2f2f'];
      for(let i=0;i<180;i++){
        confettiPieces.push({
          x: Math.random()*confettiCanvas.width,
          y: -10 - Math.random()*confettiCanvas.height*0.5,
          r: 2 + Math.random()*4,
          s: 1 + Math.random()*2.5,
          a: Math.random()*Math.PI*2,
          w: 6 + Math.random()*6,
          h: 2 + Math.random()*4,
          color: colors[(Math.random()*colors.length)|0]
        });
      }
      confettiStart = performance.now();
      requestAnimationFrame(confettiStep);
    }

    function confettiStep(ts){
      if(!confettiActive) return;
      const elapsed = ts - confettiStart;
      cctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
      for(const p of confettiPieces){
        p.y += p.s * 2.2; p.x += Math.sin((p.y+p.a)/20)*0.9;
        cctx.save(); cctx.translate(p.x, p.y); cctx.rotate((p.y+p.a)/25);
        cctx.fillStyle = p.color; cctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); cctx.restore();
      }
      // stop after ~4 seconds
      if(elapsed < 4200){ requestAnimationFrame(confettiStep); }
      else { confettiActive = false; confettiCanvas.style.display='none'; }
    }

    function checkBingo(isInitial){
      const lines = [];
      for(let r=0;r<size;r++){ lines.push([0,1,2,3,4].map(c=>r*size+c)); }
      for(let c=0;c<size;c++){ lines.push([0,1,2,3,4].map(r=>r*size+c)); }
      lines.push([0,6,12,18,24]); lines.push([4,8,12,16,20]);

      let solved = false;
      for(const line of lines){ if(line.every(i=>clicks[i])) { solved = true; break; } }

      let solvedAt = getCookie(C_SOLVED);
      if(solved && !solvedAt){
        solvedAt = new Date().toISOString();
        setCookie(C_SOLVED, solvedAt, 3650);
        launchConfetti();
        // light haptic on supported mobiles
        if('vibrate' in navigator) { try{ navigator.vibrate([40,30,40]); }catch{} }
      }

      if(solvedAt){
        try{ const d = new Date(solvedAt); completedEl.textContent = `Completed: ${d.toLocaleString()}`; }
        catch{ completedEl.textContent = `Completed: ${solvedAt}`; }
      } else if(!isInitial) { completedEl.textContent = ''; }
    }

    // ---------- Share link generator ----------
    function makeShareUrl(){
      // Embed the exact 25-cell order as base64 JSON under order=...
      const json = JSON.stringify(order);
      const b64 = b64Encode(json);
      const url = new URL(location.href);
      setParam(url, Q_ORDER, b64);
      // Keep ?data if present; otherwise it's fine—order is authoritative.
      return url.toString();
    }
    function showShare(){ const link = makeShareUrl(); shareOut.innerHTML = `<span>Share link:</span> <a class="shareLink" href="${link}">${link}</a>`; }

    document.getElementById('shareBtn').addEventListener('click', showShare);
    document.getElementById('copyBtn').addEventListener('click', async ()=>{
      const link = makeShareUrl();
      try{ await navigator.clipboard.writeText(link); shareOut.textContent = 'Link copied to clipboard!'; }
      catch{ showShare(); }
    });

    // ---------- Controls ----------
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      clicks = new Array(totalCells).fill(false); clicks[centerIdx]=true; saveClicks(); delCookie(C_SOLVED); completedEl.textContent=''; render();
    });
    document.getElementById('reshuffleBtn').addEventListener('click', ()=>{
      delCookie(C_ORDER); delCookie(C_LISTHASH); delCookie(C_SOLVED);
      clicks = new Array(totalCells).fill(false); clicks[centerIdx]=true; saveClicks();
      order = buildOrder(); render();
    });

    // ---------- Bootstrap ----------
    if(!sourceList.length && !getCookie(C_ORDER) && !orderParam){
      alert('Add your semicolon-separated list (base64) via ?data=... in the URL.\nExample: ?data=' + btoa('Hades;Maleficent;Ursula;Scar;Jafar;Cruella;Gaston;Hook;Queen of Hearts;Yzma;Shan Yu;Dr. Facilier;Mother Gothel;Lotso;Syndrome;Zurg;Tamatoa;King Candy;Chernabog;Hela;Hector Barbossa;Rourke;Judge Frollo;Randall'));
    }

    render();
  })();
  </script>
</body>
</html>
